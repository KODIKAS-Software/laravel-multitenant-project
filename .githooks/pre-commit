#!/bin/bash
# Pre-commit hook para validar cÃ³digo antes de commit

set -e

echo "ğŸ” Ejecutando validaciones pre-commit..."

# Verificar que estamos en el directorio correcto
if [ ! -f "composer.json" ]; then
    echo "âŒ Error: No se encontrÃ³ composer.json. Ejecuta desde el directorio raÃ­z del proyecto."
    exit 1
fi

# 1. Validar sintaxis PHP
echo "ğŸ“ Validando sintaxis PHP..."
find packages/kodikas/multitenant/src -name "*.php" -exec php -l {} \; > /dev/null
if [ $? -ne 0 ]; then
    echo "âŒ Error de sintaxis PHP encontrado!"
    exit 1
fi

# 2. Ejecutar PHP CS Fixer
if [ -f "vendor/bin/php-cs-fixer" ]; then
    echo "ğŸ¨ Aplicando estilo de cÃ³digo PHP..."
    vendor/bin/php-cs-fixer fix packages/kodikas/multitenant/src --dry-run --diff
    if [ $? -ne 0 ]; then
        echo "âŒ Problemas de estilo de cÃ³digo encontrados!"
        echo "ğŸ’¡ Ejecuta: vendor/bin/php-cs-fixer fix packages/kodikas/multitenant/src"
        exit 1
    fi
fi

# 3. Ejecutar PHPStan
if [ -f "vendor/bin/phpstan" ]; then
    echo "ğŸ” Ejecutando anÃ¡lisis estÃ¡tico..."
    vendor/bin/phpstan analyse packages/kodikas/multitenant/src --level=5 --no-progress
    if [ $? -ne 0 ]; then
        echo "âŒ Problemas de anÃ¡lisis estÃ¡tico encontrados!"
        exit 1
    fi
fi

# 4. Ejecutar tests unitarios del paquete
echo "ğŸ§ª Ejecutando tests unitarios..."
cd packages/kodikas/multitenant
../../../vendor/bin/phpunit --testsuite="Multitenant Unit Tests" --stop-on-failure
if [ $? -ne 0 ]; then
    echo "âŒ Tests unitarios fallaron!"
    exit 1
fi
cd - > /dev/null

# 5. Validar formato de commits
echo "ğŸ“‹ Validando formato de commit..."
commit_regex='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,50}'
commit_msg=$(cat .git/COMMIT_EDITMSG 2>/dev/null || echo "")

if [ -n "$commit_msg" ] && ! echo "$commit_msg" | grep -qE "$commit_regex"; then
    echo "âŒ Formato de commit invÃ¡lido!"
    echo "ğŸ’¡ Usa el formato: type(scope): description"
    echo "ğŸ’¡ Ejemplo: feat(auth): add JWT authentication"
    echo "ğŸ’¡ Tipos vÃ¡lidos: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
    exit 1
fi

# 6. Verificar que no hay archivos sensibles
echo "ğŸ”’ Verificando archivos sensibles..."
sensitive_files=(
    ".env"
    "*.key"
    "*.pem"
    "*.p12"
    "*.pfx"
    "*password*"
    "*secret*"
    "*token*"
)

for pattern in "${sensitive_files[@]}"; do
    if git diff --cached --name-only | grep -i "$pattern" > /dev/null; then
        echo "âŒ Archivo sensible detectado: $pattern"
        echo "ğŸ’¡ AsegÃºrate de no commitear informaciÃ³n sensible"
        exit 1
    fi
done

echo "âœ… Todas las validaciones pasaron!"
echo "ğŸš€ Procediendo con el commit..."
